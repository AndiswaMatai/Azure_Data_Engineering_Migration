# Example linked service connection string
sql_connection = {
    "type": "AzureSqlDatabase",
    "connectionString": "Server=tcp:<server>.database.windows.net;Database=<db>;Authentication=ActiveDirectoryMSI"
}

# Transform sales data for Power BI
sales_df = spark.read.format("jdbc").option("url", sql_connection["connectionString"]).option("dbtable", "Sales").load()

# Add calculated column
sales_df = sales_df.withColumn("ProfitMargin", (sales_df.Revenue - sales_df.Cost) / sales_df.Revenue)

sales_df.write.mode("overwrite").parquet("abfss://sales@datalake.dfs.core.windows.net/curated/sales_data")


CREATE OR ALTER VIEW vw_SalesPerformance AS
SELECT 
    Region,
    SUM(Revenue) AS TotalRevenue,
    SUM(Cost) AS TotalCost,
    AVG(ProfitMargin) AS AvgProfitMargin
FROM curated.sales_data
GROUP BY Region;

